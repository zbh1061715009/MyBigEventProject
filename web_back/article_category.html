<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>文章列表</title>
        <link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/iconfont.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/jquery-1.12.4.min.js"></script>
        <script src="js/bootstrap/js/bootstrap.min.js"></script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="common_title">
                文章类别管理
            </div>
            <div class="container-fluid common_con">
                <table class="table table-striped table-bordered table-hover mp20 category_table">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>Slug</th>
                            <th class="text-center" width="100">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>未分类</td>
                            <td>uncategorized</td>
                            <td class="text-center">
                                <a href="javascript:editTr({&quot;id&quot;:&quot;1&quot;,&quot;slug&quot;:&quot;uncategorized&quot;,&quot;name&quot;:&quot;未分类&quot;});"
                                    class="btn btn-info btn-xs">编辑</a>
                                <a href="javascript:deleteTr( 1 );" class="btn btn-danger btn-xs">删除</a>
                            </td>
                        </tr>

                        <tr>
                            <td>奇趣事</td>
                            <td>funny</td>
                            <td class="text-center">
                                <a href="javascript:editTr({&quot;id&quot;:&quot;2&quot;,&quot;slug&quot;:&quot;funny&quot;,&quot;name&quot;:&quot;奇趣事&quot;});"
                                    class="btn btn-info btn-xs">编辑</a>
                                <a href="javascript:deleteTr( 2 );" class="btn btn-danger btn-xs">删除</a>
                            </td>
                        </tr>

                        <tr>
                            <td>会生活</td>
                            <td>living</td>
                            <td class="text-center">
                                <a href="javascript:editTr({&quot;id&quot;:&quot;3&quot;,&quot;slug&quot;:&quot;living&quot;,&quot;name&quot;:&quot;会生活&quot;});"
                                    class="btn btn-info btn-xs">编辑</a>
                                <a href="javascript:deleteTr( 3 );" class="btn btn-danger btn-xs">删除</a>
                            </td>
                        </tr>

                        <tr>
                            <td>爱旅行</td>
                            <td>travel</td>
                            <td class="text-center">
                                <a href="javascript:editTr({&quot;id&quot;:&quot;4&quot;,&quot;slug&quot;:&quot;travel&quot;,&quot;name&quot;:&quot;爱旅行&quot;});"
                                    class="btn btn-info btn-xs">编辑</a>
                                <a href="javascript:deleteTr( 4 );" class="btn btn-danger btn-xs">删除</a>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-center">
                                <a href="javascript:void" class="btn btn-success addType" data-toggle="modal"
                                    data-target="#addModal">新增分类</a>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="modal fade" id="addModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
                        <h4 class="modal-title">新增分类</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="recipient-name" class="control-label">分类名称:</label>
                                <input type="text" class="form-control typeName" id="recipient-name">
                            </div>
                            <div class="form-group">
                                <label for="message-text" class="control-label">分类别名:</label>
                                <input type="text" class="form-control nickName" id="recipient-name">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="model_shutoff">关闭</button>
                        <button type="button" class="btn btn-primary confirmBtn" id="model_add">新增</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 准备模板 -->
        <script src="./js/art_template.js"></script>
        <script type="text/html" id="tem">
            {{each}}
            <tr>
                <td>{{$value.name}}</td>
                    <td>{{$value.slug}}</td>
                    <td class="text-center">
                        <a href="javascript:void(0)"
                            class="btn btn-info btn-xs" data-id="{{$value.id}}">编辑</a>
                        <a href="javascript:void(0)" class="btn btn-danger btn-xs" data-id="{{$value.id}}">删除</a>
                    </td>
                </tr>
            {{/each}}
        </script>

        <script>
            $(function () {

                // 获取文章列表table > tbody元素
                var myTable = $(".table-striped");
                // 获取新增分类按钮元素
                var addType = $(".addType");
                // 获取确认按钮元素
                var confirmBtn = $(".confirmBtn");
                // 记录用户编辑文章类型id
                var msgId;
                // 获取弹窗中类型名称元素
                var typeName = $(".typeName");
                // 获取弹窗中类型别名元素
                var nickName = $(".nickName");
                // 记录弹窗原始样式
                var modalBodyForm = $(".modal-body").find("form").clone(true);
                // 记录确认按钮统计次数
                var confirmCount = 1;
                // 记录修改按钮统计次数
                var editCount = 1;
                // 记录当前点击的是新增还是修改按钮
                var clickBtn = "";

                // 初始化类型列表
                getType();
                function getType() {
                    $.get({
                        url: "http://localhost:8000/admin/category_search",
                        success: function (backData) {
                            // console.log(backData);
                            var tem = template("tem", backData.data);
                            myTable.find("tbody").html(tem);
                        }
                    });
                }

                //添加新增分类按钮点击事件
                addType.click(function () {
                    $('#addModal .modal-title').html('新增分类');
                    typeName.val("");
                    nickName.val("");
                    confirmBtn.text("新增");
                    // clickBtn = "新增";
                });


                $('#addModal').modal({
                    show: false,
                    backdrop: false
                });

                $('#model_shutoff').click(function () {
                    $('#addModal').modal('hide');
                });

                $('#model_add').click(function () {
                    if (confirmCount == 2 || editCount == 2) {
                        confirmCount=1;
                        editCount=1;
                        $('#addModal').modal('hide');
                        setTimeout(function(){
                            $(".modal-body").html(modalBodyForm);
                            typeName = $(".typeName");
                            nickName = $(".nickName");
                        },200)
                        return;
                    }
                    if ($(this).text() == "新增") {
                        $('#addModal .modal-title').html('温馨提示');
                        confirmBtn.text("确认");
                        $.post({
                            url: "http://localhost:8000/admin/category_add",
                            data: {
                                name: typeName.val().trim(),
                                slug: nickName.val().trim(),
                            },
                            success: function (backData) {
                                if (backData.code == 200) {
                                    typeName.val("");
                                    nickName.val("");
                                    $(".modal-body").html("新增成功");
                                    getType();
                                } else {
                                    $(".modal-body").html("新增失败");
                                }
                            },
                            error: function () {
                                $(".modal-body").html("新增失败");
                            }
                        });
                        confirmCount++;
                    } else if ($(this).text() == "修改") {
                        $('#addModal .modal-title').html('温馨提示');
                        confirmBtn.text("确认");
                        $.post({
                            url: "http://localhost:8000/admin/category_edit",
                            data: {
                                id: msgId,
                                name: typeName.val().trim(),
                                slug: nickName.val().trim(),
                            },
                            success: function (backData) {
                                if (backData.code == 200) {
                                    typeName.val("");
                                    nickName.val("");
                                    $(".modal-body").html("修改成功");
                                    getType();
                                    msgId = undefined;
                                }else {
                                    $(".modal-body").html("修改失败");
                                }
                            },
                            error: function () {
                                $(".modal-body").html("修改失败");
                            }
                        });
                        editCount++;
                    }
                });

                $('.category_table').delegate('a', 'click', function () {
                    if ($(this).hasClass('btn-info')) {
                        $('#addModal .modal-title').html('修改分类');
                        msgId = $(this).attr("data-id");
                        confirmBtn.text("修改");
                        typeName.val($(this).parent().siblings().eq(0).text());
                        nickName.val($(this).parent().siblings().eq(1).text());
                        $('#addModal').modal('show');
                    }else if($(this).text()=="删除"){
                        $.post({
                            url:"http://localhost:8000/admin/category_delete",
                            data:{
                                id:$(this).attr("data-id"),
                            },
                            success:function(backData){
                                // console.log(backData);
                                if(backData.code==200){
                                    getType();
                                }
                            }
                        });
                    }
                })
            });    
        </script>

    </body>

</html>